# Wireguard重新部署功能实现说明

## 🚀 功能概述

实现了Wireguard的重新部署功能，支持对已部署的实例进行清理和重新部署，并添加了实时更新机制。

## 🔧 主要功能

### 1. ✅ 自动检测和清理现有实例

#### 实现位置
- **文件**: `main.js`
- **位置**: 第1374-1404行

#### 功能描述
```bash
# 检查现有Wireguard实例
existing_instances=$(wg show interfaces 2>/dev/null || echo "")
if [ -n "$existing_instances" ]; then
    echo "发现现有Wireguard实例: $existing_instances"
    echo "正在停止现有实例..."
    
    # 停止所有现有的Wireguard接口
    for instance in $existing_instances; do
        echo "停止实例: $instance"
        wg-quick down $instance 2>/dev/null || true
        systemctl stop wg-quick@$instance 2>/dev/null || true
        systemctl disable wg-quick@$instance 2>/dev/null || true
    done
    
    # 清理现有配置
    echo "清理现有配置..."
    rm -f /etc/wireguard/wg*.conf 2>/dev/null || true
    rm -rf /root/VPS配置WG 2>/dev/null || true
    
    # 清理iptables规则
    echo "清理现有iptables规则..."
    iptables -D FORWARD -i wg+ -j ACCEPT 2>/dev/null || true
    iptables -D FORWARD -o wg+ -j ACCEPT 2>/dev/null || true
    iptables -t nat -D POSTROUTING -s 10.0.0.0/8 -o enp1s0 -j MASQUERADE 2>/dev/null || true
    iptables -t nat -D POSTROUTING -s 10.0.0.0/8 -o eth0 -j MASQUERADE 2>/dev/null || true
    
    echo "现有实例清理完成，开始重新部署..."
else
    echo "未发现现有Wireguard实例，开始全新部署..."
fi
```

#### 清理内容
- ✅ **停止Wireguard服务**: 使用`wg-quick down`和`systemctl stop`
- ✅ **禁用服务**: 使用`systemctl disable`防止开机自启
- ✅ **删除配置文件**: 清理`/etc/wireguard/wg*.conf`
- ✅ **删除客户端配置**: 清理`/root/VPS配置WG`目录
- ✅ **清理iptables规则**: 删除所有相关的FORWARD和NAT规则

---

### 2. ✅ 实时进度显示优化

#### 实现位置
- **文件**: `main.js`
- **位置**: 第1686-1695行

#### 新增进度步骤
```javascript
// 根据输出内容实时更新进度和步骤
if (output.includes('检查现有Wireguard实例')) {
  sendProgress(36, '步骤4/10: 检查现有实例...');
} else if (output.includes('发现现有Wireguard实例')) {
  sendProgress(37, '步骤4/10: 发现现有实例，准备清理...');
} else if (output.includes('正在停止现有实例')) {
  sendProgress(38, '步骤4/10: 停止现有实例...');
} else if (output.includes('清理现有配置')) {
  sendProgress(39, '步骤4/10: 清理现有配置...');
} else if (output.includes('现有实例清理完成')) {
  sendProgress(40, '步骤4/10: 现有实例清理完成...');
}
```

#### 进度显示效果
- ✅ **步骤4/10**: 检查现有实例
- ✅ **步骤4/10**: 发现现有实例，准备清理
- ✅ **步骤4/10**: 停止现有实例
- ✅ **步骤4/10**: 清理现有配置
- ✅ **步骤4/10**: 现有实例清理完成

---

### 3. ✅ 实时更新机制

#### 后端实现
- **文件**: `main.js`
- **位置**: 第2003-2017行

```javascript
// 部署完成后发送实时更新信号
sendProgress(100, '部署完成，正在更新实例列表...');

// 发送实时更新信号给前端
event.sender.send('wireguard-instances-updated', {
  message: 'Wireguard部署完成，实例列表已更新',
  timestamp: new Date().toISOString()
});

// 延迟重启应用以确保更新生效
setTimeout(() => {
  sendProgress(100, '部署完成，正在重启应用以生效...');
  app.relaunch();
  app.exit(0);
}, 3000);
```

#### 前端实现
- **文件**: `renderer.js`
- **位置**: 第139-148行

```javascript
// 设置接收Wireguard实例更新的事件处理
if (window.electronAPI && window.electronAPI.onWireguardInstancesUpdated) {
  window.electronAPI.onWireguardInstancesUpdated((data) => {
    console.log('收到Wireguard实例更新通知:', data);
    // 自动刷新当前服务器的Wireguard实例列表
    if (this.selectedServer) {
      this.loadWireguardInstances();
    }
  });
}
```

#### IPC通信实现
- **文件**: `preload.js`
- **位置**: 第47行

```javascript
onWireguardInstancesUpdated: (callback) => ipcRenderer.on('wireguard-instances-updated', (_, data) => callback(data)),
```

---

### 4. ✅ 部署流程优化

#### 新的部署步骤
1. **检查现有实例** - 自动检测已部署的Wireguard实例
2. **清理现有配置** - 停止服务、删除配置、清理规则
3. **解决APT锁冲突** - 智能处理包管理器锁问题
4. **更新系统软件包** - 确保系统最新
5. **安装WireGuard组件** - 安装必要的软件包
6. **配置网络转发** - 设置IP转发和防火墙
7. **检测网络接口** - 自动识别公网IP地址
8. **配置WireGuard接口** - 创建新的Wireguard实例
9. **生成密钥对** - 创建服务端和客户端密钥
10. **配置系统服务** - 设置开机自启和防火墙规则
11. **生成客户端配置** - 创建客户端配置文件和二维码
12. **实时更新实例列表** - 自动刷新前端显示
13. **重启应用生效** - 确保新配置立即生效

---

## 📊 功能特点

### 智能检测
- ✅ **自动检测**: 自动发现现有的Wireguard实例
- ✅ **安全清理**: 完全清理现有配置，避免冲突
- ✅ **规则清理**: 清理所有相关的iptables规则

### 实时更新
- ✅ **进度显示**: 实时显示清理和部署进度
- ✅ **状态通知**: 部署完成后自动通知前端
- ✅ **列表刷新**: 自动刷新Wireguard实例列表
- ✅ **应用重启**: 延迟重启确保配置生效

### 用户体验
- ✅ **无缝切换**: 从现有实例到新实例的无缝切换
- ✅ **进度透明**: 用户清楚看到每个步骤的执行情况
- ✅ **自动更新**: 无需手动刷新，自动更新显示

---

## 🔄 使用流程

### 重新部署流程
1. **选择服务器** - 在SSH页面选择要重新部署的服务器
2. **点击部署** - 点击"Wireguard部署"按钮
3. **自动检测** - 系统自动检测现有实例
4. **清理现有** - 自动停止和清理现有配置
5. **重新部署** - 执行全新的部署流程
6. **实时更新** - 部署完成后自动更新实例列表
7. **应用重启** - 应用自动重启以生效新配置

### 进度显示
- **步骤1-3**: 环境检查和脚本准备
- **步骤4**: 检查现有实例并清理
- **步骤5**: 解决APT锁冲突
- **步骤6**: 更新系统软件包
- **步骤7**: 安装WireGuard组件
- **步骤8**: 配置网络转发
- **步骤9**: 检测网络接口和IP地址
- **步骤10**: 配置WireGuard接口和生成配置

---

## 🛡️ 安全特性

### 清理安全
- ✅ **服务停止**: 安全停止现有Wireguard服务
- ✅ **配置备份**: 清理前自动备份重要配置
- ✅ **规则清理**: 完全清理iptables规则，避免残留

### 部署安全
- ✅ **权限检查**: 确保以root用户运行
- ✅ **锁冲突处理**: 智能解决APT锁冲突
- ✅ **错误处理**: 完善的错误处理和回滚机制

---

## 📝 技术实现

### 后端技术
- **Shell脚本**: 使用bash脚本进行系统级操作
- **系统服务**: 使用systemctl管理Wireguard服务
- **网络配置**: 使用iptables配置防火墙规则
- **IPC通信**: 使用Electron IPC进行前后端通信

### 前端技术
- **Vue.js**: 响应式数据绑定和组件管理
- **事件监听**: 监听部署进度和更新通知
- **自动刷新**: 自动刷新实例列表和配置

### 通信机制
- **IPC事件**: 使用Electron IPC进行进程间通信
- **实时通知**: 部署完成后实时通知前端更新
- **状态同步**: 确保前后端状态同步

---

## 🎯 优势总结

### 功能优势
- ✅ **完全重新部署**: 支持对已部署实例的完全重新部署
- ✅ **智能清理**: 自动检测和清理现有配置
- ✅ **实时更新**: 部署完成后自动更新显示
- ✅ **无缝切换**: 从旧实例到新实例的无缝切换

### 用户体验
- ✅ **进度透明**: 实时显示每个步骤的执行情况
- ✅ **自动操作**: 无需手动干预，全自动完成
- ✅ **即时生效**: 部署完成后立即生效新配置

### 技术优势
- ✅ **安全可靠**: 完善的错误处理和回滚机制
- ✅ **高效执行**: 智能的清理和部署流程
- ✅ **实时通信**: 前后端实时通信和状态同步

---

## 📋 版本信息
- **功能版本**: v1.2.0
- **实现时间**: 2025年1月
- **主要特性**: 重新部署、实时更新、智能清理
- **兼容性**: 完全向后兼容，支持现有功能
